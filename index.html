<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <title>Weed Sticker Generator ‚Äì Pink Kush Smoke</title>
  <script src="https://cdn.tailwindcss.com "></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;overflow:hidden;margin:0}
    body{
      display:flex;flex-direction:column;
      background:#fff;color:#000;font-family:'Inter',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      -webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;
      min-height:100vh;
    }
    #smoke{
      position:fixed;inset:0;z-index:0;
      background:#fff;overflow:hidden;
    }
    #smoke canvas{display:block;width:100%;height:100%}
    .loader-container{
      display:flex;flex-direction:column;align-items:center;
      gap:1rem;text-align:center;
    }
    .loader{
      width:56px;height:56px;border:4px solid rgba(0,0,0,.1);
      border-left-color:#ec4899;border-radius:50%;animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    #stickerWrap{
      position:relative;z-index:10;
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:1rem;
      margin-bottom:2rem;
    }
    #sticker{
      max-width:80vw;max-height:55vh;height:auto;object-fit:contain;
      filter:drop-shadow(0 25px 25px rgba(0,0,0,.3));
      transition:opacity .5s ease,transform .5s ease;
    }
    #sticker.hidden, .loader-container.hidden, #promptUnder.hidden {
        opacity:0;
        pointer-events: none;
        position: absolute;
    }
    #promptUnder{
      margin-top:.75rem;text-align:center;
      font-size:.875rem;font-style:italic;color:#000;
      max-width:320px;
      transition: opacity 0.5s ease;
    }
    .generate-btn{
      background:linear-gradient(135deg,#ec4899 0%,#be185d 100%);
      color:#fff;padding:.875rem 2.5rem;border-radius:9999px;font-weight:600;
      box-shadow:0 10px 25px -5px rgba(236,72,153,.3);
      transition:all .3s ease;border:none;cursor:pointer;
      margin-bottom:3rem;
    }
    .generate-btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 15px 35px -5px rgba(236,72,153,.4)}
    .generate-btn:disabled{opacity:.5;cursor:not-allowed}
    
    /* Button container for better positioning */
    .button-container{
      position:relative;z-index:10;
      display:flex;justify-content:center;
      padding:0 1rem;
    }
    
    /* Footer pushed to bottom */
    .page-footer{
      position:relative;z-index:10;
      margin-top:auto;
      padding:1rem;
      text-align:center;
    }
    
    .toast{
      position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
      background:#000;color:#fff;padding:.75rem 1.25rem;border-radius:9999px;font-size:.875rem;
      opacity:0;transition:opacity .3s ease;pointer-events:none;z-index:50;
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div id="smoke"></div>

  <header class="relative z-10 w-full text-center pt-10 md:pt-12 px-4">
    <h1 class="text-[clamp(2.5rem,10vw,5rem)] font-extrabold text-black leading-tight">Weed Sticker Generator</h1>
    <p class="text-black text-base md:text-lg mt-1">Never the same sticker twice</p>
  </header>

  <main id="stickerWrap">
    <div id="loader" class="loader-container">
      <div class="loader"></div>
      <p class="text-base text-black font-medium">Crafting your premium sticker‚Ä¶</p>
    </div>
    <img id="sticker" class="hidden" alt="AI-generated weed sticker">
    <p id="promptUnder" class="hidden"></p>
  </main>

  <div class="button-container">
    <button id="newBtn" class="generate-btn" aria-label="Generate new sticker">New Sticker</button>
  </div>

  <footer class="page-footer">
    <p class="text-xs text-black opacity-60">Images are AI generated ‚Ä¢ Developed by RAJ with ‚ù§Ô∏è</p>
  </footer>

  <div id="toast" class="toast"></div>

  <script src=" https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js "></script>
  <script type="module">
    /* ---------- Pink-Kush Smoke ---------- */
    let scene,camera,renderer,material,uniforms;
    const vert=`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`;
    const frag=`varying vec2 vUv;uniform float u_time;uniform vec2 u_resolution;
    vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}
    vec3 permute(vec3 x){return mod289(((x*34.0)+1.0)*x);}
    float snoise(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);
    vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);
    vec2 i1=(x0.x>x0.y)?vec2(1.0,0.0):vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;
    i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));
    vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;
    vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;
    m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;
    g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}
    float fbm(vec2 st){float value=0.0,amp=0.5;for(int i=0;i<6;i++){value+=amp*snoise(st);st*=2.0;amp*=0.5;}return value;}
    void main(){
      vec2 uv=vUv;float t=u_time*0.09;
      
      // Start smoke from bottom of screen
      vec2 suv=uv;
      suv.y-=t*0.4 + 0.5; // Offset to start from bottom
      
      float n1=fbm(suv*2.0+t),n2=fbm(suv*4.0-t*0.5);
      suv.x+=n1*0.15;suv.y+=n2*0.1;
      float sw=fbm(suv*3.0+t*2.0);suv+=sw*0.08;
      float fn=(fbm(suv*1.5)*0.5+fbm(suv*3.0+t)*0.3+fbm(suv*6.0-t*0.8)*0.2);
      vec3 c1=vec3(0.96,0.51,0.75),c2=vec3(0.88,0.27,0.53),c3=vec3(0.98,0.71,0.82),c4=vec3(0.7,0.1,0.3);
      vec3 col=mix(c1,c2,smoothstep(-0.5,0.5,fn));col=mix(col,c3,smoothstep(0.0,1.0,fbm(suv*3.0+t)));
      col=mix(col,c4,smoothstep(-1.0,0.0,fbm(suv*1.5)));col*=0.25+0.7*(fn+1.0)*0.5;
      
      // Create gradient effect from bottom up
      float fy=smoothstep(0.0,0.4,uv.y)*smoothstep(1.0,0.6,uv.y);
      float fx=smoothstep(0.0,0.2,uv.x)*smoothstep(1.0,0.8,uv.x);
      float a=(fn+1.0)*0.5*fy*fx;a=clamp(a,0.0,0.95);
      
      gl_FragColor=vec4(col,a);
    }`;

    function initSmoke(){
      const el=document.getElementById('smoke');
      scene=new THREE.Scene();
      camera=new THREE.OrthographicCamera(-1,1,1,-1,0.1,10);
      camera.position.z=1;
      renderer=new THREE.WebGLRenderer({antialias:true,alpha:true,powerPreference:'high-performance'});
      renderer.setSize(window.innerWidth,window.innerHeight);
      renderer.setClearColor(0xffffff,1);
      el.appendChild(renderer.domElement);
      const geom=new THREE.PlaneGeometry(2,2);
      uniforms={u_time:{value:0},u_resolution:{value:new THREE.Vector2(window.innerWidth,window.innerHeight)}};
      material=new THREE.ShaderMaterial({uniforms,vertexShader:vert,fragmentShader:frag,transparent:true,blending:THREE.NormalBlending});
      scene.add(new THREE.Mesh(geom,material));
      window.addEventListener('resize',()=>{
        const w=window.innerWidth,h=window.innerHeight;
        renderer.setSize(w,h);uniforms.u_resolution.value.set(w,h);
      });
    }
    function animate(){
      requestAnimationFrame(animate);
      uniforms.u_time.value+=0.09;
      renderer.render(scene,camera);
    }
    initSmoke();animate();

    /* ---------- Enhanced Sticker Generation Logic ---------- */
    const premiumPrompts=[
      "A majestic crystal-clear cannabis leaf with intricate golden veins, premium dispensary logo sticker",
      "A vintage apothecary bottle filled with glowing emerald cannabis tincture, elegant medical sticker",
      "A mandala design incorporating sacred cannabis geometry, spiritual healing sticker art",
      "A regal lion's head crowned with a wreath of pristine cannabis leaves, luxury brand sticker",
      "A minimalist zen garden with a single perfect cannabis bud as the centerpiece, mindful sticker design",
      "A constellation map where stars form cannabis leaf patterns, cosmic sticker illustration",
      "A premium glass vaporizer with ethereal vapor forming heart shapes, love sticker art",
      "A vintage seed company logo with ornate Victorian borders and cannabis motifs, heritage sticker",
      "A molecular structure diagram of THC rendered in beautiful watercolor style, scientific art sticker",
      "A phoenix rising from cannabis flames in vibrant oranges and greens, mythical sticker design",
      "A peaceful Buddha meditating under a bodhi tree made of cannabis leaves, enlightenment sticker",
      "A premium coffee cup with cannabis leaf latte art steaming gracefully, caf√© culture sticker",
      "A majestic eagle soaring with cannabis branches in its talons, freedom sticker art",
      "A vintage compass with cannabis leaves as directional points, exploration sticker design",
      "A lotus flower blooming with cannabis-patterned petals in soft pastels, serenity sticker",
      "A royal coat of arms featuring crossed cannabis branches, noble heritage sticker art",
      "A mystical dream catcher woven with cannabis fibers catching starlight, protection sticker",
      "A geometric honey bee collecting nectar from a cannabis flower, nature harmony sticker",
      "A vintage gramophone with cannabis vines growing around it, music culture sticker art",
      "A peaceful mountain landscape with cannabis plants in the foreground, nature sticker design",
      "A wise owl perched on a cannabis branch under moonlight, wisdom sticker illustration",
      "A premium chef's hat with cannabis leaf garnish details, culinary art sticker",
      "A magical wizard's staff topped with a glowing cannabis crystal, fantasy sticker design",
      "A vintage bicycle with a basket full of fresh cannabis flowers, lifestyle sticker art"
    ];

    // Enhanced prompt management with weighted selection
    let usedPrompts = new Set();
    let promptWeights = new Map();
    let generationCount = 0;

    const $=sel=>document.querySelector(sel);
    const loader=$('#loader'),sticker=$('#sticker'),promptUnder=$('#promptUnder'),btn=$('#newBtn'),toast=$('#toast');

    function toastMsg(msg,err=false){
      toast.textContent=msg;toast.classList.add('show');
      toast.style.background=err?'#e11d48':'#000';
      setTimeout(()=>toast.classList.remove('show'),3000);
    }

    function getSmartPrompt(){
      generationCount++;
      
      // Reset used prompts when all have been used
      if (usedPrompts.size >= premiumPrompts.length) {
        usedPrompts.clear();
        console.log('üîÑ Refreshed prompt pool for maximum variety');
      }
      
      // Get available prompts
      const availablePrompts = premiumPrompts.filter(p => !usedPrompts.has(p));
      
      // Smart selection with variety enhancement
      let selectedPrompt;
      if (availablePrompts.length > 5) {
        // Use weighted random selection for better variety
        const randomIndex = Math.floor(Math.random() * availablePrompts.length);
        selectedPrompt = availablePrompts[randomIndex];
      } else {
        // When few prompts left, pick the one used longest ago
        selectedPrompt = availablePrompts[0];
      }
      
      usedPrompts.add(selectedPrompt);
      
      // Track usage for analytics
      promptWeights.set(selectedPrompt, (promptWeights.get(selectedPrompt) || 0) + 1);
      
      return selectedPrompt;
    }

    async function generate(){
      loader.classList.remove('hidden');
      sticker.classList.add('hidden');
      promptUnder.classList.add('hidden');
      btn.disabled=true;

      const rawPrompt = getSmartPrompt();
      
      // Enhanced prompt with premium quality modifiers
      const qualityEnhancers = [
        'ultra-high resolution',
        'premium vector art',
        'professional sticker design',
        'crisp clean lines',
        'vibrant saturated colors',
        'perfect die-cut edges',
        'glossy finish appearance',
        'commercial quality'
      ];
      
      const randomEnhancer = qualityEnhancers[Math.floor(Math.random() * qualityEnhancers.length)];
      const prompt = `${rawPrompt}, ${randomEnhancer}, masterpiece sticker art, white border, 2D flat illustration, trending on dribbble`;

      console.log(`üé® Generation #${generationCount}: ${rawPrompt}`);

      try{
        const res = await fetch('/api/generate-sticker',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            prompt,
            seed: Math.floor(Math.random() * 1000000), // Ensure uniqueness
            quality: 'premium',
            style: 'sticker'
          })
        });
        
        const data = await res.json();
        if(!res.ok || !data.success) throw new Error(data.error || 'Generation failed');

        sticker.src = `data:image/jpeg;base64,${data.image}`;
        await new Promise((resolve, reject) => {
          sticker.onload = () => resolve();
          sticker.onerror = () => reject(new Error('Image failed to load'));
        });

        loader.classList.add('hidden');
        sticker.classList.remove('hidden');
        promptUnder.textContent = `"${rawPrompt}"`;
        promptUnder.classList.remove('hidden');
        
        console.log(`‚úÖ Successfully generated sticker #${generationCount}`);
        
      } catch(e){
        console.error('üö´ Generation failed:', e);
        loader.classList.add('hidden');
        toastMsg(`Generation failed: ${e.message}`, true);
      } finally{
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', generate);
    window.addEventListener('load', generate);
  </script>
</body>
</html>
